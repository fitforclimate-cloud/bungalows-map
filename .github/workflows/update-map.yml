name: Update Bungalows Map

on:
  schedule:
    - cron: "15 */6 * * *"   # every 6 hours at minute 15
  workflow_dispatch:         # manual run button

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Run script
        run: python generate_map.py
      
      - name: List files after run
        run: ls -la

      - name: Commit outputs
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add bungalows_map.html bungalows_snapshot.csv bungalows_new.csv geo_cache.json reverse_cache.json || true
          git commit -m "Auto update map" || echo "No changes"
          git push
      
      - name: Debug funda HTML snippet
        run: |
          python - <<'PY'
          import requests
          url="https://www.funda.nl/zoeken/koop?selected_area=[%22regio-zuid-limburg,50km%22]&object_type=[%22house%22]&object_type_house=[%22bungalow%22]&publication_date=%2210%22&bedrooms=%222-%22"
          r=requests.get(url, headers={"User-Agent":"Mozilla/5.0"}, timeout=30)
          print("status:", r.status_code)
          print("len:", len(r.text))
          print("first500:", r.text[:500].replace("\\n"," "))
          print("has_detail:", "/detail/koop/" in r.text)
          PY
